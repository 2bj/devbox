indexer {
   mem_limit       = 32M
}

searchd {
   listen = 9312
   log             = /var/log/sphinxsearch/sphinx_searchd.log
   query_log       = /var/log/sphinxsearch/sphinx_query.log
   read_timeout    = 5
   max_children    = 30
   pid_file        = /var/run/sphinxsearch/searchd.pid
   max_matches     = 1000
}

### Indexes ###

# some fields are selected twice, one time with "_fti" suffix
# this ensures that the selected field becomes part of the full text index
# even if it is a sql attribute <- those ARE NOT indexed!!!

source src_aboalarm_dev {
   type            = mysql
   sql_host        = localhost
   sql_user        = root
   sql_pass        = 
   sql_db          = dev_aboalarm
   sql_port        = 3306
   sql_query_pre   = SET NAMES utf8
}

source src_aboalarm_dev_urls : src_aboalarm_dev {
    sql_query     = \
            SELECT \
                urls.id, \
                urls.url,  \
                REPLACE(urls.url, '/', ' ') AS url_fti,  \
                urls.controller_destination,  \
                urls.controller_destination AS controller_destination_fti, \
                CASE urls.controller_destination \
					when 'letter@cancellation' then 1 \
					when 'address@landingpage' then 2 \
					when 'letter@withdrawal' then 3 \
				END AS controller_destination_identifier, \
                addresses.id,  \
                addresses.first_name,  \
                addresses.last_name,   \
                addresses.name as address_name, \
                addresses.name as address_name_fti, \
                addresses.address_title, \
                addresses.zip, \
                addresses.city, \
                addresses.street, \
                providers.name as provider_name,  \
                providers.name as provider_name_fti,  \
                categories.name as category_name, \
                categories.name as category_name_fti, \
                addresses.category_id, \
                GROUP_CONCAT(tags.name SEPARATOR ',') AS tags_concat  \
            FROM urls  \
            LEFT JOIN addresses ON addresses.id = urls.address_id  \
            LEFT JOIN categories ON categories.id = addresses.category_id  \
            LEFT JOIN providers ON providers.id = addresses.provider_id  \
            LEFT JOIN lnk_tags ON lnk_tags.address_id = addresses.id  \
            LEFT JOIN tags ON tags.id = lnk_tags.tag_id  \
            WHERE urls.address_id > 0  \
                AND urls.inactive = 0  \
                AND ( urls.max_visits = -1 OR urls.visits < urls.max_visits )  \
                AND addresses.public = 1  \
            GROUP BY urls.id

    sql_attr_string      = controller_destination
    sql_attr_string      = provider_name
    sql_attr_string      = address_name
    sql_attr_string      = category_name
    sql_attr_string      = url
    sql_attr_uint        = controller_destination_identifier
    sql_attr_uint		 = category_id
    sql_query_info       = SELECT * FROM urls WHERE id=$id
}

source src_aboalarm_dev_letters : src_aboalarm_dev {
    sql_query     = \
            SELECT \
                letters.id, \
                letters.letter_id, \
                letters.user_id, \
                GROUP_CONCAT(letterdata.`value` SEPARATOR ',') AS letter_data, \
                faxes.receipt_email, \
                faxes.receipt_email as receipt_email_fti, \
				faxes.id AS fax_id \
            FROM letters \
			LEFT JOIN letter_letterdata ON letters.id = letter_letterdata.letter_id \
            LEFT JOIN letterdata ON letter_letterdata.letterdata_id = letterdata.id \
			LEFT JOIN faxes ON letters.id = faxes.letter_id \
            WHERE letters.deleted_at IS NULL \
            GROUP BY letters.id \

    sql_attr_string      = receipt_email
    sql_attr_uint        = user_id
    sql_attr_uint        = letter_id
    sql_attr_uint        = fax_id
    sql_query_info       = SELECT * FROM letters WHERE id=$id
}

source src_aboalarm_dev_users : src_aboalarm_dev {
    sql_query     = \
            SELECT \
                id, \
                id AS id_identifier, \
                email AS email_fti, \
                email, \
                first_name AS first_name_fti, \
                first_name,  \
                last_name AS last_name_fti, \
                last_name,  \
                birthdate,  \
                gender \
            FROM users

    sql_attr_string      = first_name
    sql_attr_string      = last_name
    sql_attr_string      = email
    sql_attr_uint        = id_identifier
    sql_query_info       = SELECT * FROM users WHERE id=$id
}

index idx_aboalarm_dev_urls {
    source          = src_aboalarm_dev_urls
    path            = /var/db/sphinxsearch/data/myl/aboalarm_dev_urls
    docinfo         = extern
    charset_type    = utf-8
    mlock           = 0
    morphology      = none
    min_word_len    = 2
    min_infix_len   = 2
    phrase_boundary = ., ?, !, U+2026 # horizontal ellipsis
    blend_chars     = +, &, -, U+23
}

index idx_aboalarm_dev_letters {
    source          = src_aboalarm_dev_letters
    path            = /var/db/sphinxsearch/data/myl/aboalarm_dev_letters
    docinfo         = extern
    charset_type    = utf-8
    mlock           = 0
    morphology      = none
    min_word_len    = 2
    min_infix_len   = 2
    phrase_boundary = ., ?, !, U+2026 # horizontal ellipsis
    blend_chars     = +, &, -, U+23
}

index idx_aboalarm_dev_users {
    source          = src_aboalarm_dev_users
    path            = /var/db/sphinxsearch/data/myl/aboalarm_dev_users
    docinfo         = extern
    charset_type    = utf-8
    mlock           = 0
    morphology      = none
    min_word_len    = 2
    min_infix_len   = 2
    blend_chars     = -, U+23
}